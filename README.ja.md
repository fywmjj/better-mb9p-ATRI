# ATRI -My Dear Moments- ビジュアルノベル移植版 (Xiaomi Band 9 Pro デバイス向け最適化版)

> [/IMPORTANT]
> このプロジェクトは現在活発に開発中であり、未知のバグやパフォーマンス問題が含まれている可能性があります。完全なリファクタリングとテストには時間がかかりますので、しばらくお待ちください。

---

[简体中文](/README.md) • [English (US)](/README.en_US.md) • 日本語

---

## 🤔 なぜリファクタリングが必要だったのか？

元のバージョンのコードにはいくつかの欠点があり、特にリソースが限られたデバイス（例：Xiaomi Band）では顕著でした：

*   **深刻なパフォーマンスボトルネック:** 章を切り替える際（特にデータ量の多い章）、CPU使用率が100%に急上昇し、5秒以上のラグや無応答が発生し、ゲーム体験を著しく損なっていました。
*   **文字送り効果の中断不可:** 会話テキストが逐次表示されている間、プレイヤーはクリックして全文を即座に表示することができず、効果が自然に終了するのを待つ必要があり、読書効率を低下させていました。
*   **状態管理の不備:** 元のコードにはタイマーリークの潜在的なリスク（文字送り効果の `setTimeout` が適時にクリアされない）があり、バックグラウンドでのリソース消費や予期せぬ動作を引き起こす可能性がありました。
*   **UI/UXの改善余地:** セーブ/ロード画面のデザインはより直感的で使いやすく改善可能でした。設定画面のリアルタイムプレビューと保存ロジックも最適化の余地がありました。
*   **コードの保守性:** インラインスタイルと絶対位置指定の多用により、コードの可読性、変更、拡張が困難でした。また、エラーハンドリングが不十分なため、予期せぬクラッシュのリスクが高まっていました。

---

## 🔧 私が行った変更

上記の問題に基づき、コードの全面的なリファクタリングと最適化を実施しました。主な目標は、パフォーマンス、安定性、保守性の向上です。

### ✨ 卓越したパフォーマンス向上

*   **章切り替え時のラグという核心的な問題を解決:** 厳格なタイマー管理メカニズムを導入し、シーンや章の切り替え、または会話の中断時に、古い文字送り効果の `setTimeout` が完全にクリアされるようにしました。これにより、**CPU 100%の問題を根本的に解決**し、章の切り替え時間を5秒以上から**1秒未満に大幅に短縮**、ほぼシームレスな体験を実現しました。
*   **I/O操作の最適化:** 設定の保存トリガーをスライダーのリアルタイム変更イベントから、明確な「保存」ボタンのクリックに変更しました。これにより、不要な `storage` への書き込みを減らし、頻繁なI/Oによるラグを回避しました。
*   **レンダリング効率の向上:** 算出プロパティ (`computed`) を使用して条件判断の結果をキャッシュし、テンプレートレンダリング時の冗長な計算を削減しました。多数のインラインスタイルを削除し、CSSクラスを使用。レイアウトにはFlexboxを採用し、レンダリングエンジンの効率的な動作を可能にしました。
*   **即時応答:** 文字送り効果のロジックを最適化し、効果の再生中に画面をクリックすることで**全文を即座に表示**できるようにし、次のクリックでのみ会話を進行させるようにしました。

### 🧱 より強力なプログラムの堅牢性

*   **包括的なエラーハンドリング:** JSON解析（章データ、セーブデータ、設定）、ファイル読み込み (`file.readText`)、ローカルストレージアクセス (`storage.get/set`) といった重要な操作に対して、`try...catch` または `fail` コールバック処理を追加し、データ破損やAPI呼び出しの失敗によるプログラムのクラッシュを防止しました。
*   **境界チェック:** 配列（シーンやセーブリストなど）やオブジェクトプロパティへのアクセス時に有効性チェックを実装し、範囲外のインデックスやデータ欠落によるエラーを回避しました。
*   **状態管理:** より明確な状態フラグ（例：`isMenuVisible`, `recoveryMode`）を導入し、適切なライフサイクル（例：`onHide`, `onDestroy`）でリソース（タイマーなど）をクリーンアップすることで、プログラムの安定性を向上させました。

### 🧰 より容易な保守性

*   **コード構造の最適化:** インラインスタイルを大幅に削減し、意味的なCSSクラスを使用してスタイルを定義しました。レイアウトにFlexboxを広く採用し、コードをより簡潔で適応性の高いものにしました。テンプレート構造を論理的に整理しました（例：対話レイヤー、選択肢レイヤー、メニューレイヤーの区別）。
*   **ロジックの明確化:** JavaScriptコードをリファクタリングし、より分かりやすい変数名や関数名（例：`isMenuVisible`, `clearTypingTimeout`）を使用。マジックナンバー/文字列の代わりに定数を導入。複雑な関数（`nextDialogue`など）をより小さく、単一責任の関数に分解しました。
*   **設定と状態の分離:** 設定ページに `tempSettings` を導入し、変更のリアルタイムプレビューと明示的な保存を実現し、ロジックをより明確にしました。
*   **コメントとドキュメント:** 主要なロジックを説明するためのコードコメントを追加しました。このREADME自体も、他の開発者が変更点を理解しやすくするためのものです。

---

## 免責事項

*   本プロジェクトは、原作『ATRI -My Dear Moments-』に基づいた非公式な移植および最適化であり、学習と技術研究を目的としています。
*   開発者は、Aniplex.EXE、Frontwing、枕、またはXiaomiとは一切関係ありません。
*   本アプリケーションは完全に無料であり、ソースコードはオープンソースライセンスに基づき公開されています。いかなる商業目的での使用も固く禁じます。
*   ゲームアセット（画像、テキスト、音楽など）の著作権は、それぞれの権利者に帰属します。正規品をサポートしてください。
*   本アプリケーションの使用によって生じたいかなる問題や著作権に関する紛争についても、開発者は一切の責任を負いません。

## 謝辞

*   このプロジェクトの基盤となった、最初のXiaomi Quick App移植版を作成した **@liuyuze61** 氏に感謝します。
*   パフォーマンス最適化に関する初期のアイデアを提供してくれた **@TLE** 氏に感謝します（最終的には問題を完全に解決するために異なるアプローチを採用しました）。
*   素晴らしい作品『ATRI -My Dear Moments-』を制作した Aniplex.EXE、Frontwing、枕に感謝します。
