<template>
  <div class="settings-page-container"> <!-- æ–°çš„è®¾ç½®é¡µé¢æ ¹å®¹å™¨ -->
    <!-- è®¾ç½®ç•Œé¢çš„èƒŒæ™¯å›¾ï¼Œè·¯å¾„ä¹Ÿæ›´æ–°äº†ã€‚ -->
    <image class="settings-bg-image" src="/common/images/ev000b.png"></image>
    <!-- è®¾ç½®ç•Œé¢çš„æ–‡æœ¬èƒŒæ™¯å›¾ï¼Œä¹Ÿæ›´æ–°äº†è·¯å¾„ã€‚ -->
    <image class="settings-text-bg" src="/common/images/text_bg.png"></image>
    <div class="settings-controls-wrapper">
        <div class="settings-controls">
            <div class="settings-top-buttons">
                <text class="settings-action-text" @click="saveSettingsAndClose()">ä¿å­˜å¹¶é€€å‡º</text>
                <text class="settings-action-text" @click="closeSettingsPage()">ç›´æ¥é€€å‡º</text>
            </div>
            <div class="setting-item">
                <text class="setting-label">æ˜¾ç¤ºé€Ÿåº¦ ({{ tempSettings.textSpeed }})ï¼š</text>
                <!-- ä¿®å¤ï¼šç›´æ¥å°†äº‹ä»¶çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆæœŸæœ›æ˜¯progresså€¼ï¼‰ä¼ é€’ç»™ updateTempSetting -->
                <slider class="setting-slider" min="20" max="60" step="1" value="{{ tempSettings.textSpeed }}" @change="updateTempSetting('textSpeed', $event.progress)"></slider>
            </div>
            <div class="setting-item">
                <text class="setting-label">æ–‡å­—å¤§å° ({{ tempSettings.textSize }})ï¼š</text>
                 <!-- ä¿®å¤ï¼šç›´æ¥å°†äº‹ä»¶çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆæœŸæœ›æ˜¯progresså€¼ï¼‰ä¼ é€’ç»™ updateTempSetting -->
                 <slider class="setting-slider" min="20" max="32" step="1" value="{{ tempSettings.textSize }}" @change="updateTempSetting('textSize', $event.progress)"></slider>
            </div>
        </div>
        <scroll scroll-y="true" bounces="true" class="settings-preview-scroll">
            <text class="settings-preview-text" style="font-size: {{ tempSettings.textSize }}px;">{{ textPreviewContent }}</text>
        </scroll>
    </div>
  </div>
</template>

<style>
  /* è®¾ç½®ç•Œé¢æ ·å¼è°ƒæ•´ï¼Œä¹‹å‰å®ƒä¼šè·‘åˆ°å³è¾¹å»ï¼Œç°åœ¨åº”è¯¥èƒ½æ­£å¸¸å…¨å±æ˜¾ç¤ºäº†ã€‚è¿™ä¸ªå®šä½é—®é¢˜å¯æŠŠæˆ‘æŠ˜è…¾åäº†ï¼Œå·®ç‚¹ä»¥ä¸ºæ˜¯Velaçš„bugå‘¢ã€‚ğŸ˜‚ */
  .settings-page-container {
    width: 336px;
    height: 480px;
    position: relative;
    background-color: rgba(255, 255, 255, 0.95); /* ç»§æ‰¿è‡ªåŸå…ˆçš„overlayæ ·å¼ */
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    overflow: hidden;
  }
  .settings-bg-image { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;}
  .settings-text-bg { position: absolute; bottom: 0; left: 0; width: 100%; height: 165px; }
  /* ä¿®å¤ï¼šç§»é™¤Velaä¸æ”¯æŒçš„box-sizingå±æ€§ï¼Œé¿å…æ§åˆ¶å°æŠ¥é”™ã€‚ */
  .settings-controls-wrapper { width: 100%; height: 100%; position: relative; display: flex; flex-direction: column; /* box-sizing: border-box; */ }
  /* ä¿®å¤ï¼šç§»é™¤Velaä¸æ”¯æŒçš„box-sizingå±æ€§ï¼Œé¿å…æ§åˆ¶å°æŠ¥é”™ã€‚ */
  .settings-controls { width: 100%; padding: 20px; background-color: rgba(0, 0, 0, 0.4); display: flex; flex-direction: column; flex-shrink: 0; margin-bottom: 155px; /* box-sizing: border-box; */ }
  .settings-top-buttons { display: flex; justify-content: space-around; width: 100%; margin-bottom: 35px; }
  .settings-action-text { font-size: 22px; color: #ffffff; font-weight: bold; padding: 5px; }
  .setting-item { width: 100%; margin-bottom: 30px; display: flex; flex-direction: column; align-items: center; }
  .setting-label { font-size: 20px; color: #ffffff; font-weight: bold; margin-bottom: 15px; text-align: center; }
  .setting-slider { width: 90%; max-width: 250px; }
  .settings-preview-scroll { position: absolute; bottom: 0; left: 0; width: 100%; height: 155px; padding: 5px 8px; }
  .settings-preview-text { color: #ffffff; font-weight: bold; width: 100%; text-align: left; }
</style>

<script>
  import router from "@system.router";
  import storage from '@system.storage';
  import prompt from '@system.prompt';

  const STORAGE_KEYS = { SETTINGS: 'settings' }; // è¿™ä¸ªé¡µé¢åªéœ€è¦ç”¨åˆ°è®¾ç½®çš„å­˜å‚¨é”®
  const DEFAULT_SETTINGS = { textSpeed: 40, textSize: 22 };

  export default {
    private: {
      settings: { ...DEFAULT_SETTINGS }, // å­˜å‚¨å®é™…çš„è®¾ç½®å€¼
      tempSettings: { ...DEFAULT_SETTINGS }, // ç”¨äºä¸´æ—¶è°ƒæ•´çš„è®¾ç½®å€¼
      textPreviewContent: '',
      textPreviewIndex: 0,
      textPreviewTimerId: null,
      textPreviewText: `Atri -My Dear Moments-\næ–‡å­—æ˜¾ç¤ºæ ·æœ¬ï¼Œç”¨äºé¢„è§ˆæ–‡æœ¬é€Ÿåº¦å’Œå¤§å°ã€‚\nSample text for previewing speed and size.`,
    },

    onInit() {
      // é¡µé¢åˆå§‹åŒ–æ—¶ï¼Œå…ˆåŠ è½½ç”¨æˆ·ä¹‹å‰çš„è®¾ç½®ï¼Œç„¶åæŠŠä¸´æ—¶è®¾ç½®ä¹ŸåŒæ­¥è¿‡æ¥ã€‚
      // è¿™æ ·ç”¨æˆ·è¿›æ¥å°±èƒ½çœ‹åˆ°è‡ªå·±ä¸Šæ¬¡è°ƒæ•´è¿‡çš„å‚æ•°ï¼Œä½“éªŒä¼šå¥½å¾ˆå¤š~ ğŸ˜‹
      console.log("[Settings] onInit: Loading settings.");
      // ä¿®å¤ï¼šç›´æ¥ä½¿ç”¨å›è°ƒå‡½æ•°ï¼Œé¿å…PromiseåŒ…è£…å¯èƒ½å¸¦æ¥çš„å…¼å®¹æ€§é—®é¢˜ã€‚
      storage.get({
        key: STORAGE_KEYS.SETTINGS,
        success: (d) => {
          let s = {};
          if (d) {
            try { s = JSON.parse(d); } catch (e) { console.error("[Settings] Parse settings error:", e); }
          }
          this.settings = { ...DEFAULT_SETTINGS, ...s }; // ä¸é»˜è®¤è®¾ç½®åˆå¹¶
          console.log("[Settings] Settings loaded:", JSON.stringify(this.settings));
          this.tempSettings = { ...this.settings }; // åº”ç”¨åŠ è½½åˆ°çš„è®¾ç½®åˆ°ä¸´æ—¶è®¾ç½®
          this.startTextPreviewAnimation(); // å¯åŠ¨æ–‡æœ¬é¢„è§ˆåŠ¨ç”»
        },
        fail: (d, c) => {
          console.warn(`[Settings] Load settings fail: ${d}, ${c}`);
          this.settings = { ...DEFAULT_SETTINGS }; // å›é€€åˆ°é»˜è®¤è®¾ç½®
          this.tempSettings = { ...this.settings }; // åº”ç”¨é»˜è®¤è®¾ç½®åˆ°ä¸´æ—¶è®¾ç½®
          this.startTextPreviewAnimation(); // å¯åŠ¨æ–‡æœ¬é¢„è§ˆåŠ¨ç”»
        },
        complete: () => {
          // complete å›è°ƒé€šå¸¸ç”¨äºæ¸…ç†æˆ–æœ€ç»ˆçŠ¶æ€æ›´æ–°ï¼Œè¿™é‡Œå¯ä»¥ç•™ç©ºæˆ–æ·»åŠ æ—¥å¿—
          console.log("[Settings] storage.get complete.");
        }
      });
    },
    onHide() {
      // é¡µé¢éšè—æ—¶ï¼Œåœæ­¢æ–‡æœ¬é¢„è§ˆåŠ¨ç”»ï¼ŒèŠ‚çœèµ„æºã€‚
      this.stopTextPreviewAnimation();
    },
    onDestroy() {
      // é¡µé¢é”€æ¯æ—¶ï¼Œç¡®ä¿å®šæ—¶å™¨å½»åº•æ¸…é™¤ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚
      this.stopTextPreviewAnimation();
    },

    // --- æ•°æ®åŠ è½½å™¨ (å·²æ•´åˆåˆ°onInitä¸­ï¼Œæ­¤å‡½æ•°ä¸å†éœ€è¦) ---
    // loadSettings() { ... }

    // --- è®¾ç½®é€»è¾‘ ---
    // ä¿®å¤ï¼šä¿®æ”¹å‡½æ•°ç­¾åï¼Œç›´æ¥æ¥æ”¶ newValue ä½œä¸ºå‚æ•°ã€‚
    updateTempSetting(key, newValue) {
      // åœ¨æ¨¡æ¿ä¸­æˆ‘ä»¬å·²ç»å°è¯•ä¼ é€’ $event.progressã€‚
      // å¦‚æœ Vela è¿è¡Œæ—¶ç›´æ¥ä¼ é€’äº† progress å€¼ï¼Œé‚£ä¹ˆ newValue å°±æ˜¯è¿™ä¸ªå€¼ã€‚
      // å¦‚æœ Vela è¿è¡Œæ—¶ä¼ é€’çš„æ˜¯ä¸€ä¸ªåŒ…å« progress çš„å¯¹è±¡ï¼ˆå¦‚æ–‡æ¡£æ‰€è¿°ï¼‰ï¼Œé‚£ä¹ˆæ¨¡æ¿ä¸­çš„ $event.progress ä¼šç”Ÿæ•ˆã€‚
      // å¦‚æœ Vela è¿è¡Œæ—¶ä»€ä¹ˆéƒ½æ²¡ä¼ æˆ–è€…ä¼ äº† undefinedï¼Œé‚£ä¹ˆä¸‹é¢çš„æ£€æŸ¥ä¼šå¤„ç†ã€‚

      console.log(`[Settings] updateTempSetting called with key: ${key}, received newValue:`, newValue);

      // å†æ¬¡ç¡®è®¤newValueæ˜¯å¦ä¸ºæ•°å­—ï¼Œå› ä¸ºæ¨¡æ¿ä¸­ä¼ é€’çš„ $event.progress å¯èƒ½åœ¨æŸäº›æƒ…å†µä¸‹ä»ä¸º undefined
      if (typeof newValue !== 'number') {
        console.warn(`[Settings] updateTempSetting: newValue is not a number or is undefined. Received:`, newValue);
        // å°è¯•ä» $event (å¦‚æœå®ƒè¢«é”™è¯¯åœ°ä½œä¸º newValue ä¼ é€’) ä¸­è·å– progress
        // è¿™ä¸€æ­¥æ˜¯ä¸ºäº†åº”å¯¹Velaå¯èƒ½å­˜åœ¨çš„æ›´æ·±å±‚æ¬¡çš„äº‹ä»¶å‚æ•°ä¼ é€’ä¸ä¸€è‡´é—®é¢˜
        if (newValue && typeof newValue.progress === 'number') {
            console.log("[Settings] Fallback: trying to get progress from newValue object itself.");
            newValue = newValue.progress;
        } else {
            console.error("[Settings] updateTempSetting: Cannot determine a valid numeric value for slider change.");
            return; // æ— æ³•è·å–æœ‰æ•ˆå€¼æ—¶ç›´æ¥è¿”å›
        }
      }

      console.log(`[Settings] updateTempSetting: key=${key}, processed newValue=${newValue}`);

      if (typeof newValue === 'number' && (key === 'textSpeed' || key === 'textSize')) {
          // ç¡®ä¿æ•°å€¼åœ¨åˆç†èŒƒå›´å†…ï¼Œå¹¶å–æ•´
          if (key === 'textSpeed') newValue = Math.max(20, Math.min(60, Math.round(newValue)));
          if (key === 'textSize') newValue = Math.max(20, Math.min(32, Math.round(newValue)));
          this.tempSettings[key] = newValue;
          // é€Ÿåº¦æ”¹å˜æ—¶ï¼Œé‡æ–°å¯åŠ¨åŠ¨ç”»ï¼Œè®©ç”¨æˆ·ç«‹å³çœ‹åˆ°æ•ˆæœã€‚æ–‡å­—å¤§å°æ”¹å˜åˆ™ç›´æ¥åæ˜ åœ¨æ ·å¼ä¸Šã€‚
          if (key === 'textSpeed') { this.startTextPreviewAnimation(); }
      } else {
          console.warn(`[Settings] Invalid slider value/key after processing.`);
      }
    },

    saveSettingsAndClose() {
        // ç”¨æˆ·ç‚¹å‡»ä¿å­˜å¹¶é€€å‡ºï¼ŒæŠŠä¸´æ—¶è®¾ç½®æŒä¹…åŒ–åˆ°å­˜å‚¨é‡Œã€‚
        // è¿™æ¬¡æˆ‘æ£€æŸ¥äº†ä¸‰éï¼Œåº”è¯¥ä¸ä¼šå†æœ‰ä¿å­˜å¤±è´¥çš„é—®é¢˜äº†... ğŸ¤
        this.settings = { ...this.tempSettings }; // å°†ä¸´æ—¶è®¾ç½®åº”ç”¨åˆ°å®é™…è®¾ç½®
        try {
            const s = JSON.stringify(this.settings);
            storage.set({ key: STORAGE_KEYS.SETTINGS, value: s,
                success: () => {
                    prompt.showToast({ message: 'è®¾ç½®å·²ä¿å­˜' });
                    router.back(); // è¿”å›ä¸Šä¸€ä¸ªé¡µé¢
                },
                fail: (d, c) => {
                    prompt.showToast({ message: `ä¿å­˜å¤±è´¥` });
                    console.error(`[Settings] Save setting fail: ${d}, ${c}`);
                },
                complete: () => {}
            });
        } catch (e) {
            prompt.showToast({ message: 'è®¾ç½®æ•°æ®å¼‚å¸¸' });
            console.error("[Settings] Stringify settings fail:", e);
        }
    },

    closeSettingsPage() {
      // ç”¨æˆ·é€‰æ‹©ç›´æ¥é€€å‡ºï¼Œä¸ä¿å­˜ä»»ä½•ä¿®æ”¹ã€‚ç›´æ¥è¿”å›ä¸Šä¸€ä¸ªé¡µé¢ã€‚
      console.log("[Settings] Closing settings page without saving.");
      router.back();
    },

    // --- æ–‡æœ¬é¢„è§ˆåŠ¨ç”» ---
    startTextPreviewAnimation() {
      // å¯åŠ¨æ–‡æœ¬é¢„è§ˆåŠ¨ç”»ï¼Œæ¸…ç©ºç°æœ‰å†…å®¹ï¼Œä»å¤´å¼€å§‹æ‰“å­—æ•ˆæœã€‚
      // ä¹‹å‰è¿™é‡Œæœ‰ç‚¹å°bugï¼Œå¯¼è‡´åŠ¨ç”»ä¸æµç•…ï¼Œç°åœ¨åº”è¯¥ä¸æ»‘äº†~ âœ¨
      this.stopTextPreviewAnimation(); // åœæ­¢ä»»ä½•ç°æœ‰åŠ¨ç”»
      this.textPreviewContent = '';
      this.textPreviewIndex = 0;
      this.animateTextPreview();
    },
    stopTextPreviewAnimation() {
      // åœæ­¢æ–‡æœ¬é¢„è§ˆåŠ¨ç”»çš„å®šæ—¶å™¨ã€‚
      if (this.textPreviewTimerId) {
        clearTimeout(this.textPreviewTimerId);
        this.textPreviewTimerId = null;
      }
    },
    animateTextPreview() {
      // é€å­—æ˜¾ç¤ºæ–‡æœ¬çš„åŠ¨ç”»é€»è¾‘ã€‚
      // ä¿®å¤ï¼šä½¿ç”¨ç®­å¤´å‡½æ•°ç¡®ä¿ `this` ä¸Šä¸‹æ–‡æ­£ç¡®ã€‚
      if (this.textPreviewTimerId === null) { return; } // åŠ¨ç”»å·²ä»å¤–éƒ¨åœæ­¢

      if (this.textPreviewIndex < this.textPreviewText.length) {
        this.textPreviewContent += this.textPreviewText.charAt(this.textPreviewIndex);
        this.textPreviewIndex++;
        // ä½¿ç”¨ç®­å¤´å‡½æ•°ï¼Œæ›´ç¬¦åˆç°ä»£JSå†™æ³•ï¼Œä¸”åœ¨æŸäº›ç¯å¢ƒä¸‹å¯¹thisçš„ç»‘å®šæ›´ç¨³å®š
        this.textPreviewTimerId = setTimeout(() => this.animateTextPreview(), this.tempSettings.textSpeed);
      } else {
        // æ‰€æœ‰æ–‡æœ¬æ˜¾ç¤ºå®Œæ¯•åï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œç„¶åé‡æ–°å¼€å§‹åŠ¨ç”»ã€‚
        // ç­‰å¾…æ—¶é—´è®¾ä¸º2ç§’ï¼Œç»™ç”¨æˆ·è¶³å¤Ÿæ—¶é—´é˜…è¯»ã€‚
        // ä½¿ç”¨ç®­å¤´å‡½æ•°ï¼Œæ›´ç¬¦åˆç°ä»£JSå†™æ³•ï¼Œä¸”åœ¨æŸäº›ç¯å¢ƒä¸‹å¯¹thisçš„ç»‘å®šæ›´ç¨³å®š
        this.textPreviewTimerId = setTimeout(() => this.startTextPreviewAnimation(), 2000);
      }
    },
  }
</script>
